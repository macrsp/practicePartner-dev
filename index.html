<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suzuki Practice Partner v0.2</title>
<style>
body { font-family: system-ui; margin:20px; }
.row { margin:8px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
button { padding:6px 10px; }
select,input { padding:4px; }
.small { font-size:0.9em; color:#555; }
.box { border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:12px; }
</style>
</head>
<body>

<h2>Suzuki Practice Partner</h2>

<div class="box">
  <div class="row">
    Profile:
    <select id="profileSelect"></select>
    <button id="newProfile">New</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <button id="pickFolder">Pick Music Folder</button>
    <span id="trackCount" class="small"></span>
  </div>

  <div class="row">
    <select id="trackSelect"></select>
  </div>

  <div class="row">
    <button id="markA">Mark A</button>
    <button id="markB">Mark B</button>
    <button id="saveSection">Save Section</button>
    <span id="abDisplay" class="small"></span>
  </div>

  <div class="row">
    <select id="sectionSelect"></select>
    <button id="playSection">Play</button>
    <button id="adaptivePlay">Adaptive Next</button>
    <label>
      Loop <input type="checkbox" id="loopToggle">
    </label>
  </div>

  <div class="row">
    Speed
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1.0">
    <span id="speedVal">1.00</span>
  </div>

  <div class="row small">
    Mastery: <span id="masteryDisplay">â€“</span>
  </div>
</div>

<audio id="audio" controls style="width:100%"></audio>

<script>
/* ================================
   DATA LAYER
================================ */

const DB_NAME = "suzukiPracticeDB";
let db;
let currentProfile = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);

    req.onupgradeneeded = e => {
      const db = e.target.result;

      db.createObjectStore("profiles", { keyPath: "id", autoIncrement:true });
      db.createObjectStore("sections", { keyPath: "id", autoIncrement:true });
      db.createObjectStore("plays", { keyPath: "id", autoIncrement:true });
    };

    req.onsuccess = () => { db = req.result; resolve(); };
    req.onerror = reject;
  });
}

function tx(store, mode="readonly") {
  return db.transaction(store, mode).objectStore(store);
}

/* ================================
   PROFILE SYSTEM
================================ */

async function loadProfiles() {
  const store = tx("profiles");
  const req = store.getAll();
  req.onsuccess = () => {
    const sel = document.getElementById("profileSelect");
    sel.innerHTML = "";
    req.result.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
    if(req.result.length){
      currentProfile = req.result[0].id;
      sel.value = currentProfile;
    }
  };
}

document.getElementById("newProfile").onclick = () => {
  const name = prompt("Profile name?");
  if(!name) return;
  tx("profiles","readwrite").add({ name });
  setTimeout(loadProfiles,200);
};

document.getElementById("profileSelect").onchange = e=>{
  currentProfile = Number(e.target.value);
  loadSections();
};

/* ================================
   TRACK LOADING
================================ */

let tracks = [];
let currentTrack = null;

document.getElementById("pickFolder").onclick = async ()=>{
  const dir = await window.showDirectoryPicker();
  tracks = [];
  for await (const [name,handle] of dir.entries()) {
    if(handle.kind==="file" && name.endsWith(".mp3")){
      const file = await handle.getFile();
      tracks.push({ name, file });
    }
  }
  const sel = document.getElementById("trackSelect");
  sel.innerHTML="";
  tracks.forEach((t,i)=>{
    const opt = document.createElement("option");
    opt.value=i;
    opt.textContent=t.name;
    sel.appendChild(opt);
  });
  document.getElementById("trackCount").textContent = tracks.length+" tracks loaded";
};

document.getElementById("trackSelect").onchange = e=>{
  currentTrack = tracks[e.target.value];
  const url = URL.createObjectURL(currentTrack.file);
  audio.src = url;
  loadSections();
};

/* ================================
   SECTION SYSTEM
================================ */

let A=null,B=null;

document.getElementById("markA").onclick = ()=>{
  A = audio.currentTime;
  updateAB();
};

document.getElementById("markB").onclick = ()=>{
  B = audio.currentTime;
  updateAB();
};

function updateAB(){
  document.getElementById("abDisplay").textContent =
    A!==null && B!==null ? 
    `A=${A.toFixed(1)} B=${B.toFixed(1)}` : "";
}

document.getElementById("saveSection").onclick = ()=>{
  if(A===null||B===null||!currentTrack) return;
  const name = prompt("Section name?");
  tx("sections","readwrite").add({
    profileId: currentProfile,
    trackName: currentTrack.name,
    start: Math.min(A,B),
    end: Math.max(A,B),
    mastery:0,
    playCount:0,
    lastPlayed:0
  });
  setTimeout(loadSections,200);
};

function loadSections(){
  const store = tx("sections");
  const req = store.getAll();
  req.onsuccess = ()=>{
    const sel = document.getElementById("sectionSelect");
    sel.innerHTML="";
    req.result
      .filter(s=>s.profileId===currentProfile && (!currentTrack||s.trackName===currentTrack.name))
      .forEach(s=>{
        const opt = document.createElement("option");
        opt.value=s.id;
        opt.textContent=`${s.trackName} (${s.start.toFixed(1)}-${s.end.toFixed(1)})`;
        sel.appendChild(opt);
      });
  };
}

/* ================================
   PLAY + LOOP
================================ */

const audio = document.getElementById("audio");

document.getElementById("speed").oninput = e=>{
  audio.playbackRate = e.target.value;
  document.getElementById("speedVal").textContent = Number(e.target.value).toFixed(2);
};

audio.addEventListener("timeupdate", ()=>{
  const secId = Number(document.getElementById("sectionSelect").value);
  if(!secId) return;
  tx("sections").get(secId).onsuccess=e=>{
    const s=e.target.result;
    if(!s) return;
    if(audio.currentTime>=s.end){
      if(document.getElementById("loopToggle").checked){
        audio.currentTime=s.start;
      } else {
        audio.pause();
        logPlay(s);
      }
    }
  };
});

document.getElementById("playSection").onclick = ()=>{
  const secId = Number(document.getElementById("sectionSelect").value);
  tx("sections").get(secId).onsuccess=e=>{
    const s=e.target.result;
    if(!s) return;
    audio.currentTime=s.start;
    audio.play();
  };
};

/* ================================
   LOGGING + MASTERY
================================ */

function logPlay(section){
  const now = Date.now();
  section.playCount++;
  section.lastPlayed=now;

  const days = (now - section.lastPlayed)/(1000*60*60*24);
  section.mastery = Math.min(1,
    0.3*(section.playCount/10) + 0.7*(1/(1+days))
  );

  tx("sections","readwrite").put(section);
  tx("plays","readwrite").add({
    sectionId: section.id,
    timestamp: now,
    speed: audio.playbackRate
  });

  document.getElementById("masteryDisplay").textContent =
    section.mastery.toFixed(2);
}

/* ================================
   ADAPTIVE SELECTION
================================ */

document.getElementById("adaptivePlay").onclick = ()=>{
  const store = tx("sections");
  store.getAll().onsuccess=e=>{
    const sections=e.target.result
      .filter(s=>s.profileId===currentProfile);
    if(!sections.length) return;

    const weighted = sections.map(s=>{
      const days = (Date.now()-s.lastPlayed)/(1000*60*60*24);
      const priority = (1-s.mastery)*(1+days);
      return { s, priority };
    });

    weighted.sort((a,b)=>b.priority-a.priority);
    const chosen = weighted[0].s;

    audio.currentTime=chosen.start;
    audio.play();

    document.getElementById("sectionSelect").value=chosen.id;
  };
};

/* ================================
   INIT
================================ */

(async function(){
  await openDB();
  await loadProfiles();
})();
</script>

</body>
</html>
