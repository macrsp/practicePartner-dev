<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suzuki Practice Partner</title>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #e5e7eb;
  --radius: 14px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 24px;
  background: var(--bg);
  font-family: system-ui, -apple-system, sans-serif;
  color: var(--text);
}

.container {
  max-width: 1000px;
  margin: auto;
}

h1 {
  font-size: 22px;
  margin-bottom: 20px;
  font-weight: 600;
}

.card {
  background: var(--card);
  padding: 20px;
  border-radius: var(--radius);
  margin-bottom: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.05);
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 12px;
}

button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 500;
  transition: background .2s ease;
}

button:hover { background: var(--primary-dark); }

button.secondary {
  background: #e5e7eb;
  color: var(--text);
}

select, input[type="range"] {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 14px;
}

label {
  font-size: 14px;
  color: var(--muted);
}

audio {
  width: 100%;
  margin-top: 16px;
  border-radius: 12px;
}

.mastery-pill {
  background: #e0f2fe;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  color: #0369a1;
}

.section-row {
  padding: 8px 12px;
  border-radius: 8px;
  background: #f8fafc;
  cursor: pointer;
}

.section-row:hover {
  background: #e2e8f0;
}

.small { font-size: 13px; color: var(--muted); }
</style>
</head>
<body>
<div class="container">

<h1>Suzuki Practice Partner</h1>

<div class="card">
  <div class="row">
    <label>Profile</label>
    <select id="profileSelect"></select>
    <button id="newProfile" class="secondary">New</button>
  </div>
</div>

<div class="card">
  <div class="row">
    <button id="pickFolder">Pick Music Folder</button>
    <span id="trackCount" class="small"></span>
  </div>

  <div class="row">
    <select id="trackSelect"></select>
  </div>

  <div class="row">
    <button id="markA" class="secondary">Mark A</button>
    <button id="markB" class="secondary">Mark B</button>
    <button id="saveSection">Save Section</button>
    <span id="abDisplay" class="small"></span>
  </div>

  <div class="row">
    <button id="adaptivePlay">Adaptive Next</button>
    <label>
      Loop
      <input type="checkbox" id="loopToggle">
    </label>
  </div>

  <div class="row">
    <label>Speed</label>
    <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1.0">
    <span id="speedVal">1.00</span>
  </div>

  <div class="row">
    <div class="mastery-pill">
      Mastery: <span id="masteryDisplay">â€“</span>
    </div>
  </div>

  <div id="sectionList"></div>

  <audio id="audio" controls></audio>
</div>

</div>

<script>
/* =================================
   DATABASE
================================= */

const DB_NAME = "suzukiDB_v4";
let db;
let currentProfile = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      db.createObjectStore("profiles", { keyPath: "id", autoIncrement:true });
      db.createObjectStore("sections", { keyPath: "id", autoIncrement:true });
      db.createObjectStore("plays", { keyPath: "id", autoIncrement:true });
    };
    req.onsuccess = () => { db = req.result; resolve(); };
    req.onerror = reject;
  });
}

function store(name, mode="readonly") {
  return db.transaction(name, mode).objectStore(name);
}

/* =================================
   PROFILE SYSTEM
================================= */

async function loadProfiles() {
  const req = store("profiles").getAll();
  req.onsuccess = () => {
    const sel = document.getElementById("profileSelect");
    sel.innerHTML = "";
    req.result.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
    if(req.result.length){
      currentProfile = req.result[0].id;
      sel.value = currentProfile;
      loadSections();
    }
  };
}

document.getElementById("newProfile").onclick = ()=>{
  const name = prompt("Profile name?");
  if(!name) return;
  store("profiles","readwrite").add({ name });
  setTimeout(loadProfiles,200);
};

document.getElementById("profileSelect").onchange = e=>{
  currentProfile = Number(e.target.value);
  loadSections();
};

/* =================================
   TRACK LOADING
================================= */

let tracks=[];
let currentTrack=null;
const audio=document.getElementById("audio");

document.getElementById("pickFolder").onclick = async ()=>{
  const dir = await window.showDirectoryPicker();
  tracks=[];
  for await (const [name,handle] of dir.entries()){
    if(handle.kind==="file" && name.endsWith(".mp3")){
      const file=await handle.getFile();
      tracks.push({name,file});
    }
  }
  const sel=document.getElementById("trackSelect");
  sel.innerHTML="";
  tracks.forEach((t,i)=>{
    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent=t.name;
    sel.appendChild(opt);
  });
};

document.getElementById("trackSelect").onchange = e=>{
  currentTrack=tracks[e.target.value];
  audio.src=URL.createObjectURL(currentTrack.file);
  buildWaveform(currentTrack.file);
  loadSections();
};

/* =================================
   WAVEFORM + SELECTION
================================= */

let canvas, ctx;
let audioBuffer;
let selection = { start:null, end:null };
let dragging = false;

function initCanvas(){
  canvas = document.createElement("canvas");
  canvas.height = 120;
  canvas.style.width = "100%";
  canvas.style.marginTop = "16px";
  audio.parentNode.insertBefore(canvas, audio);
  ctx = canvas.getContext("2d");

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  canvas.addEventListener("mousedown", startDrag);
  canvas.addEventListener("mousemove", drag);
  canvas.addEventListener("mouseup", endDrag);
}

function resizeCanvas(){
  canvas.width = canvas.offsetWidth;
  drawWaveform();
}

async function buildWaveform(file){
  const arrayBuffer = await file.arrayBuffer();
  const audioCtx = new AudioContext();
  audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
  drawWaveform();
}

function drawWaveform(){
  if(!audioBuffer) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const data = audioBuffer.getChannelData(0);
  const step = Math.ceil(data.length / canvas.width);
  const amp = canvas.height/2;

  ctx.fillStyle = "#d1d5db";

  for(let i=0;i<canvas.width;i++){
    let min=1,max=-1;
    for(let j=0;j<step;j++){
      const datum = data[(i*step)+j];
      if(datum<min) min=datum;
      if(datum>max) max=datum;
    }
    ctx.fillRect(i, (1+min)*amp, 1, Math.max(1,(max-min)*amp));
  }

  drawSelection();
}

function drawSelection(){
  if(selection.start==null||selection.end==null) return;

  const sPx = timeToPx(selection.start);
  const ePx = timeToPx(selection.end);

  ctx.fillStyle = "rgba(59,130,246,0.2)";
  ctx.fillRect(Math.min(sPx,ePx),0,Math.abs(ePx-sPx),canvas.height);

  ctx.setLineDash([6,4]);
  ctx.strokeStyle="#3b82f6";
  ctx.beginPath();
  ctx.moveTo(sPx,0); ctx.lineTo(sPx,canvas.height);
  ctx.moveTo(ePx,0); ctx.lineTo(ePx,canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);
}

function pxToTime(px){
  return (px/canvas.width)*audioBuffer.duration;
}

function timeToPx(time){
  return (time/audioBuffer.duration)*canvas.width;
}

function startDrag(e){
  dragging=true;
  const rect=canvas.getBoundingClientRect();
  selection.start=pxToTime(e.clientX-rect.left);
  selection.end=selection.start;
  drawWaveform();
}

function drag(e){
  if(!dragging) return;
  const rect=canvas.getBoundingClientRect();
  selection.end=pxToTime(e.clientX-rect.left);
  drawWaveform();
}

function endDrag(){
  dragging=false;
}

document.getElementById("saveSection").onclick=()=>{
  if(selection.start==null||selection.end==null||!currentTrack) return;
  store("sections","readwrite").add({
    profileId:currentProfile,
    trackName:currentTrack.name,
    start:Math.min(selection.start,selection.end),
    end:Math.max(selection.start,selection.end),
    playCount:0,
    mastery:0,
    lastPlayed:0
  });
  loadSections();
};

/* =================================
   SECTION PLAY + LOOP
================================= */

audio.addEventListener("timeupdate",()=>{
  const id=audio.dataset.sectionId;
  if(!id) return;
  store("sections").get(Number(id)).onsuccess=e=>{
    const s=e.target.result;
    if(!s) return;
    if(audio.currentTime>=s.end){
      if(document.getElementById("loopToggle").checked){
        audio.currentTime=s.start;
      } else {
        audio.pause();
        logPlay(s);
      }
    }
  };
});

function playSection(s){
  audio.currentTime=s.start;
  audio.dataset.sectionId=s.id;
  audio.play();
}

/* =================================
   LOGGING + ADAPTIVE
================================= */

function logPlay(section){
  const now=Date.now();
  section.playCount++;
  const days=(now-section.lastPlayed)/(1000*60*60*24);
  section.lastPlayed=now;
  section.mastery=Math.min(1,
    0.5*(section.playCount/10)+0.5*(1/(1+days))
  );

  store("sections","readwrite").put(section);
  store("plays","readwrite").add({
    sectionId:section.id,
    timestamp:now,
    speed:audio.playbackRate
  });

  document.getElementById("masteryDisplay").textContent=
    section.mastery.toFixed(2);
}

document.getElementById("adaptivePlay").onclick=()=>{
  store("sections").getAll().onsuccess=e=>{
    const sections=e.target.result.filter(s=>s.profileId===currentProfile);
    if(!sections.length) return;
    sections.sort((a,b)=>(1-b.mastery)-(1-a.mastery));
    playSection(sections[0]);
  };
};

/* =================================
   INIT
================================= */

(async()=>{
  await openDB();
  await loadProfiles();
  initCanvas();
})();
</script>



</body>
</html>
